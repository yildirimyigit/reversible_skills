FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive

# --- OS deps for PyRep/RLBench + X11/GL runtime ---
RUN apt-get update && apt-get install -y \
    python3.8 python3.8-dev python3-pip python3-venv \
    git wget ca-certificates \
    build-essential cmake pkg-config \
    libffi-dev \
    # X/GL runtime libs commonly needed by CoppeliaSim/PyRep
    libglib2.0-0 libsm6 libxrender1 libxext6 libxi6 libxrandr2 libxinerama1 libxcursor1 \
    libxkbcommon-x11-0 libxcb-randr0 \
    libfontconfig1 libfreetype6 libdbus-1-3 \
    libgl1 libglvnd0 libegl1 libglx0 \
    libx11-xcb1 libxcb1 libxcb-xinerama0 libxcb-icccm4 libxcb-image0 \
    libxcb-keysyms1 libxcb-render-util0 libxcb-xkb1 libxcb-cursor0 \
    nano \
    && rm -rf /var/lib/apt/lists/*

# --- CoppeliaSim 4.1.0 (as RLBench expects) ---
ENV COPPELIASIM_ROOT=/opt/CoppeliaSim
RUN mkdir -p ${COPPELIASIM_ROOT} && \
    wget -q https://downloads.coppeliarobotics.com/V4_1_0/CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz -O /tmp/cs.tar.xz && \
    tar -xf /tmp/cs.tar.xz -C ${COPPELIASIM_ROOT} --strip-components 1 && \
    rm -f /tmp/cs.tar.xz

# --- Persistent env vars for PyRep/CoppeliaSim ---
ENV LD_LIBRARY_PATH=${COPPELIASIM_ROOT}:${LD_LIBRARY_PATH}
ENV QT_QPA_PLATFORM_PLUGIN_PATH=${COPPELIASIM_ROOT}
ENV QT_QPA_PLATFORM=xcb
#ENV QT_DEBUG_PLUGINS=1

ENV XDG_RUNTIME_DIR=/tmp/runtime-root
RUN mkdir -p /tmp/runtime-root && chmod 700 /tmp/runtime-root

# --- Python deps + PyRep + RLBench ---
RUN python3.8 -m pip install --upgrade pip setuptools wheel && \
    python3.8 -m pip install "gymnasium==0.29.1" "shimmy>=1.3.0" && \
    # PyRep commonly needs this pinned build dep
    python3.8 -m pip install "cffi==1.14.2" && \
    python3.8 -m pip install --no-build-isolation "pyrep @ git+https://github.com/stepjam/PyRep.git" && \
    python3.8 -m pip install "rlbench @ git+https://github.com/stepjam/RLBench.git"

WORKDIR /workspace
CMD ["bash"]
